@{
    Layout = "_Layout_Front";
}
<!-- BREADCRUMB -->
<div id="breadcrumb" class="section">
	<!-- container -->
	<div class="container">
		<!-- row -->
		<div class="row">
			<div class="col-md-12">
				<strong>
					搜尋條件:
				</strong>
				<span id="searchcriteria" style="color:darkred;">進入分類:</span>
				<ul class="breadcrumb-tree">
				</ul>
			</div>
		</div>
		<!-- /row -->
	</div>
	<!-- /container -->
</div>
<!-- /BREADCRUMB -->
<!-- SECTION -->
<div class="section">
	<!-- container -->
	<div class="container">
		<!-- row -->
		<div class="row">
			<!-- ASIDE -->
			<div id="aside" class="col-md-3">
				<!-- aside Widget -->
@* 				<div class="aside">
					<h3 class="aside-title">商品分類(單選)</h3>
					<div class="checkbox-filter">
						<div class="input-checkbox">
							<input type="checkbox" id="category-1">
							<label for="category-1">
								<span></span>
								配件
								<small>(12)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-2">
							<label for="category-2">
								<span></span>
								飾品
								<small>(74)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-3">
							<label for="category-3">
								<span></span>
								包包
								<small>(14)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-4">
							<label for="category-4">
								<span></span>
								生活瓷器
								<small>(20)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-5">
							<label for="category-5">
								<span></span>
								香氛產品
								<small>(10)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-6">
							<label for="category-6">
								<span></span>
								寵物用品
								<small>(13)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-7">
							<label for="category-7">
								<span></span>
								手機周邊
								<small>(21)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-8">
							<label for="category-8">
								<span></span>
								辦公用品
								<small>(33)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-9">
							<label for="category-9">
								<span></span>
								文具用品
								<small>(7)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-10">
							<label for="category-10">
								<span></span>
								零食
								<small>(67)</small>
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="category-11">
							<label for="category-11">
								<span></span>
								保健食品
								<small>(15)</small>
							</label>
						</div>
					</div>
				</div>  *@
				<!-- /aside Widget -->
				<!-- 價錢區域 -->
				<div class="aside">
					<h3 class="aside-title">依價格搜尋:</h3>
					<div class="price-filter">
						<div id="price-slider"></div>
						<div class="input-number price-min">
							<input id="price-min" type="number">
							<span class="qty-up">+</span>
							<span class="qty-down">-</span>
						</div>
						<span>-</span>
						<div class="input-number price-max">
							<input id="price-max" type="number">
							<span class="qty-up">+</span>
							<span class="qty-down">-</span>
						</div>
					</div>
				</div>
				<!-- /價錢區域 -->
				<!-- aside Widget -->
				<div class="aside">
					<h3 class="aside-title">依條件篩選:</h3>
					<div class="checkbox-filter">
						<div class="input-checkbox">
							<input type="checkbox" id="brand-1">
							<label for="brand-1">
								<span></span>
								4星以上
							</label>
						</div>
						<div class="input-checkbox">
							<input type="checkbox" id="brand-2">
							<label for="brand-2">
								<span></span>
								3星以上
							</label>
						</div>
						<div>-------------------------</div>
						<div class="input-checkbox">
							<input type="checkbox" id="brand-3">
							<label for="brand-3">
								<span></span>
								尚有庫存
							</label>
						</div>
						<div>-------------------------</div>
						<div class="input-checkbox">
							<input type="checkbox" id="brand-4">
							<label for="brand-4">
								<span></span>
								活動優惠
							</label>
						</div>
					</div>
				</div>
				<!-- /aside Widget -->
				<!-- 隨機推薦 -->
				<div class="aside">
				<h3 class="aside-title">為您推薦:</h3>
				</div>
				<div class="aside" id="idforu">
					<div class="product-widget">				
					</div>
				</div>
				<!-- /隨機推薦 -->
			</div>
			<!-- /ASIDE -->
			<!-- STORE -->
			<div id="store" class="col-md-9">
				<!-- store top filter -->
				<div class="store-filter clearfix">
					<div class="store-sort">
						<label>
							<strong>
								商品排序:
								</strong>
							<select class="input-select" id="idshowsort">
								<option value="bestscore|desc">評價 高到低</option>
								<option value="bestscore|asc">評價 低到高</option>
								<option value="UnitPrice|desc">金額 高到低</option>
								<option value="UnitPrice|asc">金額 低到高</option>
								<option value="bestsale|desc">熱銷度 高到低</option>
								<option value="bestsale|asc">熱銷度 低到高</option>

							</select>
						</label>
						<label>
							<strong>
							顯示商品數:
							</strong>
							<select class="input-select" id="idshowhowmanypro">
								<option value="9" selected>每頁9項商品</option>
								<option value="18">每頁18項商品</option>
								<option value="27">每頁27項商品</option>
							</select>
						</label>
						<label>
							<strong>
								搜尋結果:
								</strong>
									共&nbsp;
							<span id="searchresult" style="color:darkred"></span>&nbsp;項商品&nbsp;&nbsp;
						</label>
					</div>

				</div>
				<!-- /store top filter -->
				<!-- 搜尋結果區 -->
				<div class="row" id="idshowpro">
				</div>
				<!-- /store products -->
				<!-- 分頁按鈕 -->
				<div class="store-filter clearfix" style="width:65%;margin:0 auto;text-align:center;">
					<ul class="store-pagination" id="idpageul">
@* 						<li class="active">1</li>
						<li><a href="#">2</a></li>
						<li><a href="#">3</a></li>
						<li><a href="#">4</a></li>
						<li><a href="#"><i class="fa fa-angle-right"></i></a></li>  *@
					</ul>
				</div>
				<!-- /分頁按鈕 -->
							</div>
							<!-- /STORE -->
						</div>
						<!-- /row -->
					</div>
					<!-- /container -->
				</div>
				<!-- /SECTION -->

@section Styles
{
    <style>
/* 		.Acategory {
			border: 150px;
			padding: 50px; /* 设置内边距 */
			border-radius: 5px; /* 圆角半径 */
		} */
    </style>
}

@section Scripts
{
    <script>
		//分頁按鈕
		const idpageul = document.getElementById("idpageul");
		//左邊隨機推薦五項
		const divleft = document.getElementById('idforu');
		//商品展示區
		const div1 = document.getElementById('idshowpro');
		//搜尋框&按鈕
		const form = document.getElementById('idform');
		const inpSearch = document.getElementById('idinputsearch');
		const searchButton = document.getElementById('idsearchButton');
		//顯示數量
		const showhowmanypro = document.getElementById('idshowhowmanypro');
		//顯示排序
		const showsort = document.getElementById('idshowsort');
		//搜尋結果文字顯示
		const searchresult = document.getElementById('searchresult');
		const searchcriteria = document.getElementById('searchcriteria');
		//顯示分類
		const idultree = document.getElementById('idultree');
		//最高最低金額
		const Hbar = document.getElementById('price-max');
		const Lbar = document.getElementById('price-min');
		const Low = document.querySelector('.noUi-handle-lower');
		const High = document.querySelector('.noUi-handle-upper');
		function priceChange() {
			searchData.lowPrice = Lbar.value;
			searchData.highPrice = Hbar.value;
			console.log('pricebar', Hbar.value);
			console.log('pricebar', Lbar.value);			
		}
		Lbar.addEventListener('blur', priceChange);
		Hbar.addEventListener('blur', priceChange);
		//Low.addEventListener('mouseout', priceChange)
		//High.addEventListener('mouseout', priceChange)
		//被點分頁
		//TODO
		// const gored = idpageul.getElementsByTagName('li');
		// const pageR = () => {
		// 	for (let i = 0; i < gored.length; i++) {
		// 		gored[i].addEventListener('click', (event) => {
		// 			event.preventDefault();
		// 			for (let j = 0; j < gored.length; j++) {
		// 				//gored[j].classList.remove('active');
		// 				gored[j].style.backgroundColor = 'white';
		// 				console.log("out");
		// 			}
		// 			//event.currentTarget.classList.add('active');
		// 			event.currentTarget.style.backgroundColor = 'red';
		// 		})
		// 	}
		// }

		//連到分類
		const categoryHandler = cat => {
			searchData.subcatId = cat;
			console.log(searchData.subcatId);
			console.log(searchData);
			ifChange();
		}
		//連到頁數
		const pagingHandler = page => {
			searchData.page = page;
			ifChange();
		}
		//B.顯示分頁按鈕-下一頁
		const loadMore = (max, start) => {
			//顯示更多分頁按鈕 (start 至 start+7)
			let liPages = "";
			let whichpage = Math.ceil(max / 8);
			let end = Math.min(start + 8, max + 1);//選取比較小的值作為最尾端頁數
			liPages += `<li onclick="goBack(${max}, ${start - 8})"><</a></li>`;
			for (let i = start; i < end; i++) {
				liPages += `<li onclick="pagingHandler(${i})" id="li${i}"><a>${i}</a></li>`;
			}
			if (end <= max) {
				liPages += `<li onclick="loadMore(${max}, ${start + 8})">></a></li>`;
			}
			idpageul.innerHTML = liPages;
		}
		//B.顯示分頁按鈕-回上頁
		const goBack = (max, start) => {
			let liPages = "";
			let end = Math.min(start + 8, max + 1);//選取比較小的值作為最尾端頁數
			if (start > 1) {
				liPages += `<li onclick="goBack(${max}, ${start - 8})"><</a></li>`;
			}
			for (let i = start; i < end; i++) {
				liPages += `<li onclick="pagingHandler(${i})" id="li${i}"><a>${i}</a></li>`;
			}
			liPages += `<li onclick="loadMore(${max}, ${start + 8})">></a></li>`;
			idpageul.innerHTML = liPages;
		}
        const searchData = {
			"subcatId": 0,
			"searchword": "",
			"page": 1,
			"pagesSize": 9,
			"sortBy": "",
			"sortType": "asc",
			"lowPrice":null,
			"highPrice": null
		};

		// 顯示分類按鈕
		(async function loadCatli() {
			const urlC = 'https://localhost:7160/api/SubcatDTO/';
			const responseC = await fetch(urlC);
			const dataC = await responseC.json();
			const liCat = dataC.map(cats => {
				const { subCategoryId, subCategoryCname } = cats;
				return `<li onclick="categoryHandler(${subCategoryId})" value="${subCategoryId}"><a class="Acategory" id="idc${subCategoryId}">${subCategoryCname}</a></li>`;
			});
			idultree.innerHTML = `<li onclick="categoryHandler(0)" value="0" id="idc0"><a class="Acategory">全部</a></li>`;
			idultree.innerHTML += liCat.join("");
			//被點分類換色
			const category = document.querySelectorAll('.Acategory');
			for (var item of category) {
				item.addEventListener('click', (event) => {
					for (var i of category) {
						i.style.fontSize = '14px';
						i.style.color = 'black';
					}
					event.target.style.fontSize = '21px';
					event.target.style.color = '#D44949';

				})
			};

			console.log("ss");
		})();
			//左邊隨機推薦
		const foru = async () => {
			let sortBy = ["", "UnitPrice", "bestsale", "bestscore", "coldpro", ""];
			let sortType = ["", "desc", "asc", "desc", "asc", "desc"];
			let ran = Math.ceil(Math.random() * 5);
			const url = 'https://localhost:7160/api/SearchProduct';
			const response = await fetch(url, {
				method: 'POST',
				body: JSON.stringify({
					"categoryId": ran,
					"keyword": "",
					"page": 1,
					"pagesSize": 9,
					"sortBy": sortBy[ran],
					"sortType": sortType[ran]
				}),
				headers: {
					'Content-Type': 'application/json'
				}
			});
			const data = await response.json();
			const foru = data.showProducts.map(f => {
				const { productphoto, productName, productId, unitPrice, labelName } = f;
				return (`							<div class="product-widget">
				<div class="product-img">
				${productphoto ? `<img src="data:image/jpeg;base64,${productphoto}" alt=""/>` : 'No Image Available'}
						</div>
							<div class="product-body">
										<p class="product-category">${labelName}</p>
								<h3 class="product-name"><a href="https://localhost:7066/homepage/index/${productId}">${productName}</a></h3>
								<h4 class="product-price">$${unitPrice}<del class="product-old-price">${Math.round(unitPrice * 1.25)}</del></h4>
												</div></div>`);
			})
			divleft.innerHTML = foru.join("");
		
		};


		

		//顯示商品
			const loadPro = async () => {
				const url = 'https://localhost:7160/api/SearchProduct';
				const response = await fetch(url, {
					method: 'POST',
					body: JSON.stringify(searchData),
					headers: {
						'Content-Type': 'application/json'
					}
				});
				const data = await response.json();
				const pros = data.showProducts.map(pro => {
					const { productId, productName, discount, labelName, unitPrice, productphoto, score, isnew } = pro;
					return (`<a href="https://localhost:7066/homepage/index/${productId}">
				<div class="col-md-4 col-xs-6">
						 <div class="product">
								<div class="product-img">
									${productphoto ? `<img style="width: 262px; height: 280px;object-fit:contain" src="data:image/jpeg;base64,${productphoto}" alt=""/>` : 'No Image Available'}
										<div class="product-label">
											<span class="sale">全館8折優惠</span>
																		${isnew ? '<span class="new">新上市</span>' : ''}
							</div> 
							</div>
							<div class="product-body">
									<p class="product-category">${labelName}</p>
							<h3 class="product-name"><a href="#">${productName}</a></h3>
							<h4 class="product-price">$${unitPrice}<del class="product-old-price">${Math.round(unitPrice * 1.25)}</del></h4>
									<div class="product-rating">
						${Array(Math.floor(score)).fill('<i class="fa fa-star" style="font-size: 13px;"></i> ').join('')}
											${score - Math.floor(score) > 0.4 ? '<i class="fa fa-star-half" style="font-size: 13px;"></i>' : ''}
							</div>
							<div class="product-btns">
								<button class="add-to-wishlist"><i class="fa fa-heart-o"></i><span class="tooltipp">加入願望清單</span></button>
								<button class="add-to-compare"><i class="fas fa-share-from-square"></i><span class="tooltipp">分享商品</span></button>
								<button class="quick-view"><i class="fa fa-shopping-cart"></i><span class="tooltipp">加入購物車</span></button>
								</div>
								</div>
								<div class="add-to-cart">
								<button class="add-to-cart-btn"><i class="fa-solid fa-bag-shopping"></i>直接購買</button>
								</div>
							</div>
						</div></a>`)
				})
				div1.innerHTML = pros.join("");
			searchresult.textContent = `${data.totalCount}`;
			if (data.totalCount == 0) {
				alert("找沒有! 為您隨機推薦其他好物!♥");
				inpSearch.value = "";
				searchData.searchword = "";
				searchData.sortBy = "coldpro";
				searchData.sortType = "asc";
				searchData.page = 1;
				loadPro();
				return;
			}
			searchcriteria.textContent = `關鍵字:${searchData.searchword}`;
			const max = data.totalPages;
			//B.顯示分頁按鈕
			const loadPage = (max) => {
				let liPages = "";
				let whichpage = Math.ceil(max / 8);
				if (whichpage > 1) {
					for (let i = 1; i < 9; i++) {
						liPages += `<li onclick="pagingHandler(${i})" id="li${i}" class="aaa">${i}</li>`;
					}
					liPages += `<li onclick="loadMore(${max},9)">></li>`;
				}
				else {
					for (let i = 1; i <= max; i++) {
						liPages += `<li onclick="pagingHandler(${i})"><a>${i}</a></li>`;
					}
				}
				idpageul.innerHTML = liPages;
			}
			if (0 < searchData.page && searchData.page < 9) {
				loadPage(max);
			}
			else if (8 < searchData.page && searchData.page < 17) {
				loadMore(max, 9);
			}
			else if (16 < searchData.page && searchData.page < 24) {
				loadMore(max, 17);
			}
			else if (24 < searchData.page && searchData.page < 32) {
				loadMore(max, 25);
			}
			else { loadMore(max, 33) }
			foru();
			window.scrollTo(0, 0);
			//分頁顏色測試
			// const pages = document.querySelectorAll('.aaa');
			// pages.forEach(item => {
			// 	item.addEventListener('click', (event) => {
			// 		pages.forEach(page => {
			// 			page.classList.remove('active');
			// 		});
			// 		event.target.classList.add('active');
			// 	});
			// });
		}
		foru();
		loadPro();
		function ifChange() {
			searchData.searchword = inpSearch.value;
			searchData.pagesSize = showhowmanypro.value;
			const selectedsort = showsort.value.split('|');
			searchData.sortBy = selectedsort[0];
			searchData.sortType = selectedsort[1];
			loadPro();
		 }
		//D.搜尋
		// searchButton.addEventListener('click', ifChange);
		// inpSearch.addEventListener('keydown', event => {
		// 	if (event.keyCode === 13) {
		// 		ifChange();
		// 	}
		// })

		//A.顯示數量
		showhowmanypro.addEventListener('change', ifChange);
		showsort.addEventListener('change', ifChange);
		//移除提交功能
		form.addEventListener('submit', function (event) {
			event.preventDefault();
			ifChange();
		});

   </script>
}